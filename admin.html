<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RCCIIT Student Companion</title>
    <!--
      Modern, iOS-inspired styling + fluid animations.
      Inline comments are added throughout (HTML, CSS, JS) to explain complex parts.
    -->
    <style>
        /* -----------------------------
           Design system (variables) — easy to tweak
           ----------------------------- */
        :root{
            --bg: #f2f5f9; /* soft background */
            --card: rgba(255,255,255,0.75);
            --glass: rgba(255,255,255,0.6);
            --muted: #646f7a;
            --accent: #0a84ff; /* bright iOS-blue */
            --accent-2: #5e60ff;
            --text: #0b1220;
            --radius: 12px;
            --shadow-1: 0 6px 18px rgba(11,18,32,0.08);
            --shadow-2: 0 10px 30px rgba(11,18,32,0.12);
            --glass-border: rgba(255,255,255,0.6);
            --glass-blur: 10px;
            --ease: cubic-bezier(.2,.9,.3,1);
        }

        /* Respect users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
        }

        /* Body and layout */
        html,body{height:100%;}
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 0; padding: 24px; background: linear-gradient(180deg,var(--bg), #eef4fb); color:var(--text); -webkit-font-smoothing:antialiased; }

        header{
            max-width:1100px; margin:0 auto 22px; display:flex; align-items:center; justify-content:space-between; gap:16px;
            background: linear-gradient(90deg, rgba(10,132,255,0.12), rgba(94,96,255,0.06));
            padding:18px 22px; border-radius:16px; backdrop-filter: blur(var(--glass-blur)); box-shadow: var(--shadow-1);
        }
        header h1{ margin:0; font-size:20px; letter-spacing:0.2px; }
        header .sub{ color:var(--muted); font-size:13px }

        /* Central container — glass card */
        .container { max-width: 980px; margin: 18px auto; background: var(--card); border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow-2); border: 1px solid rgba(255,255,255,0.6); backdrop-filter: blur(8px);
            transition: transform 420ms var(--ease), box-shadow 420ms var(--ease);
        }
        .container:focus-within { transform: translateY(-6px); box-shadow: 0 22px 48px rgba(11,18,32,0.14); }

        /* Buttons — pill shaped with subtle motion */
        .btn { display:inline-flex; align-items:center; gap:10px; justify-content:center; padding:10px 16px; font-weight:600; border-radius:999px; text-decoration:none; cursor:pointer; border:none; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; box-shadow: 0 8px 24px rgba(10,132,255,0.18); transition: transform 260ms var(--ease), box-shadow 260ms var(--ease), opacity 260ms var(--ease); }
        .btn:hover{ transform: translateY(-4px) scale(1.01); box-shadow: 0 18px 38px rgba(10,132,255,0.22); }
        .btn.ghost{ background: transparent; color:var(--text); border:1px solid rgba(11,18,32,0.06); box-shadow:none; }

        /* Login section layout — modern split card */
        .login-section { display: grid; grid-template-columns: 1fr 1fr; gap:18px; align-items:center; }
        .auth-card{ padding:18px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.5), rgba(255,255,255,0.35)); border:1px solid rgba(11,18,32,0.04); box-shadow: 0 8px 24px rgba(11,18,32,0.04); }

        h2{ margin:0 0 8px 0; }
        p{ color:var(--muted); margin:0 0 12px 0; }

        .form-group{ margin-bottom:14px; }
        label{ display:block; font-size:13px; margin-bottom:6px; color:var(--muted); }
        select, input[type='text'], input[type='password'], input[type='file']{
            width:100%; padding:12px; border-radius:10px; border:1px solid rgba(11,18,32,0.06); outline:none; background: transparent; box-shadow: inset 0 -1px 0 rgba(11,18,32,0.02);
            transition: box-shadow 200ms var(--ease), transform 200ms var(--ease);
        }
        select:focus, input:focus{ box-shadow: 0 8px 20px rgba(11,18,32,0.06); transform: translateY(-2px); }

        .greyed{ background:#f7f9fc; pointer-events:none; opacity:0.85; }

        /* Menu grid for dashboard — cards with slight hover lift */
        .menu-grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:14px; margin-top:12px; }
        .menu-card{ background:linear-gradient(180deg, #fff, rgba(255,255,255,0.92)); padding:14px; border-radius:12px; text-align:center; box-shadow: 0 8px 22px rgba(11,18,32,0.06); cursor:pointer; transition: transform 300ms var(--ease), box-shadow 300ms var(--ease); }
        .menu-card:hover{ transform: translateY(-8px); box-shadow: 0 28px 60px rgba(11,18,32,0.12); }
        .menu-card small{ display:block; color:var(--muted); margin-top:8px; }

        /* Container for PDF viewers and large content */
        #pdfViewer, #holidayViewer{ width:100%; height:520px; border-radius:12px; overflow:hidden; background: repeating-linear-gradient(45deg,#fbfdff, #fbfdff 10px, #f6fafc 10px, #f6fafc 20px); display:flex; align-items:center; justify-content:center; color:var(--muted); }

        /* Table styling for preview */
        table{ width:100%; border-collapse: collapse; margin-top:8px; }
        th, td{ padding:10px 12px; border-bottom:1px solid rgba(11,18,32,0.04); text-align:left; }
        thead th{ background: linear-gradient(90deg, rgba(10,132,255,0.06), rgba(94,96,255,0.03)); }

        /* small responsive tweaks */
        @media (max-width:780px){ .login-section{ grid-template-columns:1fr; } header{ flex-direction:column; gap:8px; align-items:start; } #pdfViewer,#holidayViewer{ height:360px; } }

        /* Hidden elements - used for page navigation */
        .hidden { display: none !important; }

        /* subtle page entrance animation */
        @keyframes floatIn { from { opacity:0; transform: translateY(10px) scale(0.995);} to { opacity:1; transform: none; } }
        .container { animation: floatIn 420ms var(--ease) both; }
        .page {
            will-change: transform, opacity;
            /* make sure we render on its own composite layer for smoothness */
            transform-origin: center;
            /* ensure consistent baseline */
            min-height: 100vh;
        }

        /* ENTER (on load) - subtle scale + fade + slide up */
        .page-enter {
            animation: pageEnter 520ms cubic-bezier(.2,.9,.3,1) both;
        }

        @keyframes pageEnter {
            0%   { opacity: 0; transform: translateY(10px) scale(0.996); filter: blur(2px); }
            60%  { opacity: 1; transform: translateY(-4px) scale(1.002); filter: blur(0.4px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }

        /* EXIT (before navigation) - fade out + scale down + slide up */
        .page-exit {
            animation: pageExit 420ms cubic-bezier(.34,.95,.4,1) both;
        }

        @keyframes pageExit {
            0%   { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
            40%  { opacity: 0.7; transform: translateY(-6px) scale(0.998); filter: blur(0.6px); }
            100% { opacity: 0; transform: translateY(-18px) scale(0.992); filter: blur(2px); }
        }

        /* Optional: a slightly different effect for modal-ish subpages */
        .page-exit-fast {
            animation: pageExit 260ms cubic-bezier(.3,.9,.3,1) both;
        }

        /* Improve performance on mobile (reduce heavy effects if prefers-reduced-motion) */
        @media (prefers-reduced-motion: reduce) {
            .page-enter, .page-exit, .page-exit-fast { animation: none !important; opacity: 1 !important; transform: none !important; }
        }
    
  /* Wrapper: apply to the top-level container that holds the page (e.g. body or #main container) */
  .page {
    will-change: transform, opacity;
    /* make sure we render on its own composite layer for smoothness */
    transform-origin: center;
    /* ensure consistent baseline */
    min-height: 100vh;
  }

  /* ENTER (on load) - subtle scale + fade + slide up */
  .page-enter {
    animation: pageEnter 520ms cubic-bezier(.2,.9,.3,1) both;
  }

  @keyframes pageEnter {
    0%   { opacity: 0; transform: translateY(10px) scale(0.996); filter: blur(2px); }
    60%  { opacity: 1; transform: translateY(-4px) scale(1.002); filter: blur(0.4px); }
    100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
  }

  /* EXIT (before navigation) - fade out + scale down + slide up */
  .page-exit {
    animation: pageExit 420ms cubic-bezier(.34,.95,.4,1) both;
  }

  @keyframes pageExit {
    0%   { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
    40%  { opacity: 0.7; transform: translateY(-6px) scale(0.998); filter: blur(0.6px); }
    100% { opacity: 0; transform: translateY(-18px) scale(0.992); filter: blur(2px); }
  }

  /* Optional: a slightly different effect for modal-ish subpages */
  .page-exit-fast {
    animation: pageExit 260ms cubic-bezier(.3,.9,.3,1) both;
  }

  /* Improve performance on mobile (reduce heavy effects if prefers-reduced-motion) */
  @media (prefers-reduced-motion: reduce) {
     .page-enter, .page-exit, .page-exit-fast { animation: none !important; opacity: 1 !important; transform: none !important; }
  }
</style>
</head>
<body>
    <header>
        <div>
            <h1>RCCIIT Student Companion</h1>
            <div class="sub">by SynthetIQ</div>
        </div>
        <div>
            <!-- small quick actions with micro-interactions -->
            <button class="btn" onclick="showAdminLogin()" aria-label="Admin Login">Login</button>
        </div>
    </header>

    <!-- Main card -->
    <div class="container" id="mainPage" role="main" aria-labelledby="welcome">
        <h2 id="welcome">Welcome, admin.</h2>
       
    </div>

    <!-- Admin Login Page -->
    <div class="container hidden" id="adminLogin">
        <h2>Admin Login</h2>

        <div class="form-group">
            <label for="adminUser">Admin Username</label>
            <input id="adminUser" type="text" placeholder="Enter username" />
        </div>

        <div class="form-group">
            <label for="adminPass">Password</label>
            <input id="adminPass" type="password" placeholder="Enter password" />
        </div>

        <a class="btn" href="#" id="adminLoginBtn">Login</a>
        <br><br>
        <a class="btn ghost" href="#" onclick="goBack()">Back</a>
    </div>

    <!-- Admin Dashboard Page -->
    <div class="container hidden" id="adminDashboard">
        <h2>Admin Dashboard</h2>
        <h3>Academic Calendar Upload</h3>
        <p>Upload exam calendars in PDF format. The system will extract activity rows and dates automatically and let you save a department copy.</p>

        <div class="form-group">
            <label for="calendarDept">Select Department (this will be the department copy)</label>
            <select id="calendarDept">
                <option value="AIML">CSE (AI & ML)</option>
                <option value="CS">CSE</option>
                <option value="ECE">ECE</option>
                <option value="EE">EE</option>
                <option value="IT">IT</option>
            </select>
        </div>

        <div class="form-group">
            <label for="calendarPDF">Upload Calendar PDF</label>
            <input type="file" id="calendarPDF" accept="application/pdf" />
        </div>

        <a class="btn" href="#" onclick="processCalendar()">Upload & Analyse</a>
        <br><br>

        <h3>Uploaded Files</h3>
        <a class="btn" href="#" onclick="showUploadedFiles()">View Stored Files</a>
        <br><br>
        <h3>Holiday Calendar Upload</h3>
        <p>Upload holiday calendar PDF (no parsing required).</p>
        <div class="form-group">
            <label for="holidayDept">Select Department</label>
            <select id="holidayDept">
                <option value="AIML">CSE (AI & ML)</option>
                <option value="CS">CSE</option>
                <option value="ECE">ECE</option>
                <option value="EE">EE</option>
                <option value="IT">IT</option>
            </select>
        </div>
        <div class="form-group">
            <label for="holidayPDF">Upload Holiday PDF</label>
            <input type="file" id="holidayPDF" accept="application/pdf" />
        </div>
        <a class="btn" href="#" onclick="uploadHolidayCalendar()">Upload Holiday Calendar</a>
        <br><br>
        <a class="btn" href="index.html" onclick="logoutAdmin()">Logout</a>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px">
          
    <!-- Preview container will be inserted here dynamically -->

    <!-- pdf.js library (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        /*
          showUploadedFiles: draws a floating container listing files saved in localStorage.
          - uses a dynamic container so it can be removed/inserted without reloading.
        */
        function showUploadedFiles() {
            const containerId = 'uploadedFilesContainer';
            let container = document.getElementById(containerId);
            if (container) container.remove(); // remove old one if present

            container = document.createElement('div');
            container.id = containerId;
            container.className = 'container';

            const title = document.createElement('h3');
            title.innerText = 'Stored Uploaded Files';
            container.appendChild(title);

            // --- compute storage used (rough characters -> bytes estimate) ---
            let total = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                total += (localStorage.getItem(key)?.length || 0);
            }
            const kb = (total / 1024).toFixed(2);
            const mb = (total / 1024 / 1024).toFixed(2);
            const usage = document.createElement('p');
            usage.innerHTML = `<b>Storage Used:</b> ${kb} KB (${mb} MB)`;
            container.appendChild(usage);

            // filter buttons to quickly show categories
            const filterDiv = document.createElement('div');
            filterDiv.innerHTML = `
                <button class='btn ghost' onclick="filterFiles('all')">All</button>
                <button class='btn ghost' onclick="filterFiles('pdf')">PDF Only</button>
                <button class='btn ghost' onclick="filterFiles('parsed')">Parsed Data Only</button>
            `;
            container.appendChild(filterDiv);

            const list = document.createElement('ul'); list.id = 'fileList'; container.appendChild(list);
            loadFiles('all');

            const adminDash = document.getElementById('adminDashboard');
            adminDash.parentNode.insertBefore(container, adminDash.nextSibling);

            // subtle entrance animation
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // loadFiles: enumerates localStorage keys and renders list items
        function loadFiles(type) {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            let count = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('calendar_pdf_') || key.startsWith('holiday_pdf_') || key.startsWith('calendar_')) {
                    if (type === 'pdf' && !key.includes('pdf')) continue;
                    if (type === 'parsed' && !key.startsWith('calendar_')) continue;
                    const li = document.createElement('li');
                    // use simple markup but accessible controls
                    li.innerHTML = `${key} <a href='#' onclick="deleteFile('${key}')">[Delete]</a>`;
                    list.appendChild(li);
                    count++;
                }
            }
            if (count === 0) list.innerHTML = '<p>No files in this category.</p>';}

        function filterFiles(type){ loadFiles(type); }

        // single delete function used across UI
        function deleteFile(key) {
            if (confirm('Delete this file?')) {
                localStorage.removeItem(key);
                loadFiles('all');
            }
        }

        // Upload holiday calendar: store PDF as base64 in localStorage
        function uploadHolidayCalendar() {
            const dept = document.getElementById('holidayDept').value;
            const file = document.getElementById('holidayPDF').files[0];
            if (!file) { alert('Upload a PDF'); return; }
            const reader = new FileReader();
            reader.onload = e => {
                localStorage.setItem('holiday_pdf_' + dept, e.target.result);
                alert('Holiday calendar uploaded!');
            };
            reader.readAsDataURL(file);
        }
    </script>

    <script>
        // ---------- Show/Hide Password ----------
        function togglePassword(inputId, checkboxId) {
            const input = document.getElementById(inputId);
            const checkbox = document.getElementById(checkboxId);
            input.type = checkbox.checked ? 'text' : 'password';
        }

        // ---------- Admin credentials (placeholder) ----------
        // In production this should be replaced by secure backend authentication.
        const defaultAdmin = { username: "admin", password: "synthetiq123" };

        // ---------- simple navigation helpers with small ARIA toggles ----------
        function showStudentLogin() {
            // hide main -> reveal student login smoothly
            document.getElementById("mainPage").classList.add("hidden");
            document.getElementById("studentLogin").classList.remove("hidden");
            document.getElementById("studentLogin").setAttribute('aria-hidden','false');
            // focus first input for keyboard users (micro-interaction)
            setTimeout(()=>document.getElementById('studentDept').focus(),150);
        }

        function showAdminLogin() {
            document.getElementById("mainPage").classList.add("hidden");
            document.getElementById("adminLogin").classList.remove("hidden");
            document.getElementById("adminLogin").setAttribute('aria-hidden','false');
            setTimeout(()=>document.getElementById('adminUser').focus(),150);
        }

        function goBack() {
            // hide login cards and bring mainPage back
            ['studentLogin','adminLogin','studentDashboard','adminDashboard'].forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('mainPage').setAttribute('aria-hidden','false');
        }

        // ---------- AIML section auto-grey (UX rule) ----------
        function deptChanged() {
            const dept = document.getElementById("studentDept").value;
            const sectionBox = document.getElementById("studentSection");

            if (dept === "AIML") {
                // AIML department always uses Section A — visually show it as disabled
                sectionBox.value = "A";
                sectionBox.classList.add("greyed");
            } else {
                sectionBox.classList.remove("greyed");
            }
        }

        // ---------- student navigation / viewers ----------
        function openSection(id) {
            // hide dashboard and show target
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');

            // Academic calendar viewer: loads PDF stored for selected department
            if (id === 'acadCalPage') {
                const dept = document.getElementById('studentDept').value || document.getElementById('calendarDept')?.value;
                const base64PDF = localStorage.getItem('calendar_pdf_' + dept);
                const viewer = document.getElementById('pdfViewer');
                // If present, create an iframe for smooth in-place viewing.
                viewer.innerHTML = base64PDF ? `<iframe src="${base64PDF}" style="width:100%; height:100%; border:none;"></iframe>` : "No PDF uploaded for your department.";
            }

            // Holiday calendar viewer: uses holiday storage key
            if (id === 'holidayPage') {
                const dept = document.getElementById('studentDept').value || document.getElementById('holidayDept')?.value;
                const base64PDF = localStorage.getItem('holiday_pdf_' + dept);
                const viewer = document.getElementById('holidayViewer');
                viewer.innerHTML = base64PDF ? `<iframe src="${base64PDF}" style="width:100%; height:100%; border:none;"></iframe>` : "No Holiday PDF uploaded.";
            }

            // smooth scroll to top of the displayed container
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        function backToDashboard() {
            // hide all known student sub-pages then show dashboard
            document.querySelectorAll('#noticePage, #acadCalPage, #classPage, #holidayPage, #timetablePage, #contactsPage, #eventsPage').forEach(el => el.classList.add('hidden'));
            document.getElementById('studentDashboard').classList.remove('hidden');
            document.getElementById('studentDashboard').scrollIntoView({ behavior: 'smooth' });
        }

        function studentContinue() {
            // basic local password check — replace with secure mechanism later
            const dept = document.getElementById('studentDept').value;
            const pwd = document.getElementById('studentPassword').value;
            const stored = localStorage.getItem('dept_password_' + dept);

            if (stored && stored !== pwd) {
                alert('Incorrect department password.');
                return;
            }

            document.getElementById("studentLogin").classList.add("hidden");
            document.getElementById("studentDashboard").classList.remove("hidden");
        }

        function logoutStudent() {
            document.getElementById("studentDashboard").classList.add("hidden");
            document.getElementById("mainPage").classList.remove("hidden");
        }

        // ---------- admin login handling ----------
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;

            if (username === defaultAdmin.username && password === defaultAdmin.password) {
                document.getElementById("adminLogin").classList.add("hidden");
                document.getElementById("adminDashboard").classList.remove("hidden");
            } else {
                alert("Incorrect admin credentials.");
            }
        });

        function logoutAdmin() {
            document.getElementById("adminDashboard").classList.add("hidden");
            document.getElementById("mainPage").classList.remove("hidden");
        }

        /*
           PDF parsing helpers
           - normalizeDate: converts 1/2/25 -> 01/02/2025 (best-effort)
           - processCalendar: uses pdf.js to extract text and a regex to find date ranges.
           NOTE: This is best-effort. Many college calendars are image-based — OCR would be needed in that case.
        */
        function normalizeDate(str) {
            if (!str) return null;
            const parts = str.split('/');
            if (parts.length !== 3) return null;
            let [d, m, y] = parts.map(s => s.trim());
            if (y.length === 2) y = '20' + y;
            if (d.length === 1) d = '0' + d;
            if (m.length === 1) m = '0' + m;
            return `${d}/${m}/${y}`;
        }

        async function processCalendar() {
            const file = document.getElementById('calendarPDF').files[0];
            if (!file) { alert('Please upload a PDF first.'); return; }

            try {
                // Read the PDF into memory as ArrayBuffer (client-side)
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;
                let fullText = '';

                // Extract text content from each page. This relies on PDF text objects existing.
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    fullText += strings.join(' ') + '\n';
                }

                // normalise spacing & find semester sections by header words
                const text = fullText.replace(/\u00A0/g, ' ');
                const sec1Idx = text.search(/1st Semester/i);
                const sec3Idx = text.search(/3rd Semester/i);

                let sec1Text = '', sec3Text = '', restText = '';
                if (sec1Idx !== -1 && sec3Idx !== -1) {
                    if (sec1Idx < sec3Idx) {
                        sec1Text = text.slice(sec1Idx, sec3Idx);
                        sec3Text = text.slice(sec3Idx);
                    } else {
                        sec3Text = text.slice(sec3Idx, sec1Idx);
                        sec1Text = text.slice(sec1Idx);
                    }
                } else if (sec1Idx !== -1) {
                    sec1Text = text.slice(sec1Idx);
                } else if (sec3Idx !== -1) {
                    sec3Text = text.slice(sec3Idx);
                } else {
                    restText = text;
                }

                // extractRows: finds patterns like "ActivityName   dd/mm/yy   dd/mm/yy"
                function extractRows(sectionText) {
                    const rows = [];
                    const dateRangeRegex = /([A-Za-z0-9\-\/\:\\(\)\. &]+?)\s+(\d{1,2}\/\d{1,2}\/\d{2,4})\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/g;
                    let match;
                    while ((match = dateRangeRegex.exec(sectionText)) !== null) {
                        const activity = match[1].trim().replace(/\s{2,}/g, ' ');
                        const start = normalizeDate(match[2]);
                        const end = normalizeDate(match[3]);
                        if (start && end) rows.push({ activity, start, end });
                    }
                    return rows;
                }

                const sec1Rows = extractRows(sec1Text || restText);
                const sec3Rows = extractRows(sec3Text || restText);

                const result = {
                    uploadedAt: new Date().toISOString(),
                    departmentProvided: document.getElementById('calendarDept').value,
                    semester1: sec1Rows,
                    semester3: sec3Rows
                };

                showPreview(result);
            } catch (e) {
                console.error(e);
                alert('Error parsing PDF. Check that the calendar is text-based (not image-only) and try again.');
            }
        }

        // ---------- preview & save ----------
        function showPreview(parsed) {
            // Remove any existing preview container before drawing new
            const existing = document.getElementById('previewContainer');
            if (existing) existing.remove();

            const container = document.createElement('div');
            container.id = 'previewContainer';
            container.className = 'container';

            const h = document.createElement('h3'); h.innerText = 'Parsed Calendar Preview';
            container.appendChild(h);

            const info = document.createElement('p');
            info.innerText = `Department: ${parsed.departmentProvided} — Uploaded: ${new Date(parsed.uploadedAt).toLocaleString()}`;
            container.appendChild(info);

            // makeTable: builds a simple HTML table for detected rows
            function makeTable(rows, title) {
                const titleEl = document.createElement('h4'); titleEl.innerText = title;
                container.appendChild(titleEl);

                if (!rows || rows.length === 0) {
                    const p = document.createElement('p'); p.innerText = 'No rows detected.'; container.appendChild(p); return;
                }

                const table = document.createElement('table');
                table.style.marginBottom = '12px';
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th style="text-align:left; padding:8px; border-bottom:1px solid #ccc">Activity</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ccc">Start Date</th><th style="text-align:left; padding:8px; border-bottom:1px solid #ccc">End Date</th></tr>';
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                rows.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td style="padding:8px; border-bottom:1px solid #eee">${r.activity}</td><td style="padding:8px; border-bottom:1px solid #eee">${r.start}</td><td style="padding:8px; border-bottom:1px solid #eee">${r.end}</td>`;
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                container.appendChild(table);
            }

            makeTable(parsed.semester1, '1st Semester');
            makeTable(parsed.semester3, '3rd Semester');

            const saveBtn = document.createElement('a');
            saveBtn.className = 'btn'; saveBtn.href = '#'; saveBtn.innerText = 'Save to Department';
            saveBtn.onclick = function() { saveDepartmentCalendar(parsed); };
            container.appendChild(saveBtn);

            const backBtn = document.createElement('a');
            backBtn.className = 'btn ghost'; backBtn.href = '#'; backBtn.style.marginLeft = '10px';
            backBtn.innerText = 'Close Preview'; backBtn.onclick = function() { container.remove(); };
            container.appendChild(backBtn);

            // insert after adminDashboard
            const adminDash = document.getElementById('adminDashboard');
            adminDash.parentNode.insertBefore(container, adminDash.nextSibling);
            // scroll to preview with smooth motion
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function saveDepartmentCalendar(parsed) {
            const dept = parsed.departmentProvided;
            // Save parsed JSON data
            localStorage.setItem('calendar_' + dept, JSON.stringify(parsed));

            // Save PDF as Base64 for viewing
            const fileInput = document.getElementById('calendarPDF');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                localStorage.setItem('calendar_pdf_' + dept, base64);
                alert('Calendar saved (PDF + parsed data) for department: ' + dept);
            };
            reader.readAsDataURL(file);
        }

    </script>
    <!-- Added script: robust show/hide navigation + convert password checkboxes to eye buttons -->
<script>
(function(){
  // Centralized pages list (keeps in sync with canvas layout)
  const ALL_PAGES = [
    'mainPage','studentLogin','studentDashboard','noticePage','acadCalPage','classPage','holidayPage','timetablePage','contactsPage','eventsPage','adminLogin','adminDashboard'
  ];

  function showOnly(ids){
    const show = Array.isArray(ids) ? ids : [ids];
    ALL_PAGES.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(show.includes(id)) { el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
      else { el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
    });
    const target = document.getElementById(show[0]);
    if(target) target.scrollIntoView({behavior:'smooth'});
  }

  // Expose to global scope so existing onclick handlers continue to work
  window.showOnly = showOnly;
  window.showStudentLogin = function(){ showOnly('studentLogin'); setTimeout(()=>document.getElementById('studentDept')?.focus(),150); };
  window.showAdminLogin = function(){ showOnly('adminLogin'); setTimeout(()=>document.getElementById('adminUser')?.focus(),150); };
  window.goBack = function(){ showOnly('mainPage'); };
  window.backToDashboard = function(){ showOnly('studentDashboard'); };
  window.logoutStudent = function(){ showOnly('mainPage'); };
  window.logoutAdmin = function(){ showOnly('mainPage'); };

  // Replace old checkbox-based 'show password' with eye buttons
  function svgEye(){ return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7z" stroke="#334155" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="#334155" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }
  function svgEyeOff(){ return '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-5 0-9.27-3.11-11-7 1.14-2.56 2.9-4.66 5.12-6.04" stroke="#334155" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M1 1l22 22" stroke="#334155" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }

  window.togglePasswordEye = function(inputId, btn){
    const input = document.getElementById(inputId);
    if(!input) return;
    const isPwd = input.type === 'password';
    input.type = isPwd ? 'text' : 'password';
    btn.innerHTML = isPwd ? svgEyeOff() : svgEye();
    input.focus();
  };

  // On DOM ready: find checkbox controls used previously and replace them with eye buttons
  document.addEventListener('DOMContentLoaded', ()=>{
    // Find checkboxes whose id starts with 'show' (pattern used earlier)
    document.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      try{
        // Many of the checkboxes had onclick like: togglePassword('studentPassword','showStudentPass')
        const onclick = cb.getAttribute('onclick') || '';
        const match = onclick.match(/togglePassword\(['"]?([a-zA-Z0-9_-]+)['"]?\s*,\s*['"]?([a-zA-Z0-9_-]+)['"]?\)/);
        if(!match) return;
        const targetInputId = match[1];

        // Create eye button
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'eye-btn';
        btn.setAttribute('aria-label','Toggle password visibility');
        btn.innerHTML = svgEye();
        btn.addEventListener('click', ()=> window.togglePasswordEye(targetInputId, btn));

        // Replace the checkbox's parent label content with the eye button
        const parent = cb.closest('label');
        if(parent){
          // remove the checkbox (and any text) then append the eye button
          parent.parentNode.replaceChild(btn, parent);
        } else {
          // fallback: replace checkbox directly
          cb.parentNode.replaceChild(btn, cb);
        }
      }catch(e){/* non-fatal */}
    });

    // Also ensure any standalone .eye-wrap buttons (those already in HTML) use the new handler and reflect state
    document.querySelectorAll('.eye-wrap button.eye-btn').forEach(btn=>{
      const onclick = btn.getAttribute('onclick') || '';
      // if onclick already points to togglePasswordEye, keep it. Otherwise try to infer target by looking for nearby input
      if(!onclick.includes('togglePasswordEye')){
        // find input in same container
        const container = btn.closest('.password-field');
        if(container){
          const input = container.querySelector('input');
          if(input){
            btn.addEventListener('click', ()=> window.togglePasswordEye(input.id, btn));
          }
        }
      }
    });
  });

  // For safety: if any old functions are still referenced elsewhere, ensure they exist and delegate to new implementations
  window.openSection = function(id){
    // if opening a student subpage, show that page; if opening a dashboard, show dashboard
    if(ALL_PAGES.includes(id)) { showOnly(id); }
    // load PDF viewers when requested (maintain previous behaviour)
    if (id === 'acadCalPage') {
      const dept = document.getElementById('studentDept')?.value || document.getElementById('calendarDept')?.value;
      const base64PDF = localStorage.getItem('calendar_pdf_' + dept);
      const viewer = document.getElementById('pdfViewer');
      if(viewer) viewer.innerHTML = base64PDF ? `<iframe src="${base64PDF}" style="width:100%; height:100%; border:none"></iframe>` : 'No PDF uploaded for your department.';
    }
    if (id === 'holidayPage') {
      const dept = document.getElementById('studentDept')?.value || document.getElementById('holidayDept')?.value;
      const base64PDF = localStorage.getItem('holiday_pdf_' + dept);
      const viewer = document.getElementById('holidayViewer');
      if(viewer) viewer.innerHTML = base64PDF ? `<iframe src="${base64PDF}" style="width:100%; height:100%; border:none"></iframe>` : 'No Holiday PDF uploaded.';
    }
  };

  // Ensure admin login button still hooks up if DOM was already loaded earlier
  document.addEventListener('DOMContentLoaded', ()=>{
    const adminBtn = document.getElementById('adminLoginBtn');
    if(adminBtn && !adminBtn._patched){
      adminBtn._patched = true;
      adminBtn.addEventListener('click', function(e){ e.preventDefault(); const username = document.getElementById('adminUser').value; const password = document.getElementById('adminPass').value; if(username === defaultAdmin.username && password === defaultAdmin.password){ showOnly('adminDashboard'); } else { alert('Incorrect admin credentials.'); } });
    }
  });
})();
</script>
<!-- Added script: robust show/hide navigation -->
<script>
(function(){
  // Centralized pages list for admin.html
  const ALL_PAGES = [
    'mainPage','adminLogin','adminDashboard'
  ];

  function showOnly(ids){
    const show = Array.isArray(ids) ? ids : [ids];
    ALL_PAGES.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(show.includes(id)) { el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
      else { el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
    });
    const target = document.getElementById(show[0]);
    if(target) target.scrollIntoView({behavior:'smooth'});
  }

  // Expose to global scope
  window.showOnly = showOnly;
  window.showAdminLogin = function(){ showOnly('adminLogin'); setTimeout(()=>document.getElementById('adminUser')?.focus(),150); };
  window.goBack = function(){ showOnly('mainPage'); };
  window.logoutAdmin = function(){ showOnly('mainPage'); };

  // Ensure admin login button is hooked up
  document.addEventListener('DOMContentLoaded', ()=>{
    const adminBtn = document.getElementById('adminLoginBtn');
    if(adminBtn && !adminBtn._patched){
      adminBtn._patched = true;
      adminBtn.addEventListener('click', function(e){ e.preventDefault(); const username = document.getElementById('adminUser').value; const password = document.getElementById('adminPass').value; if(username === defaultAdmin.username && password === defaultAdmin.password){ showOnly('adminDashboard'); } else { alert('Incorrect admin credentials.'); } });
    }
  });
})();
</script>

</body>
</html>
